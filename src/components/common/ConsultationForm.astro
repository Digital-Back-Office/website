---
import 'flatpickr/dist/flatpickr.min.css'
import 'flatpickr/dist/themes/dark.css'
const url = Astro.url.pathname
---

<style>
          .error {
            padding: 0.3rem 1rem;
            color: #52cec7;
            background-color: black;
            border-radius: 4px;
            position: absolute;
            top: 100%;
            left: 1rem;
            font-style: italic;
            font-size: 0.9rem;
          }
          .error::after {
            content: '';
            position: absolute;
            border-radius: 2px;
            width: 0.9rem;
            height: 0.9rem;
            transform: rotate(45deg);
            background-color: black;
            top: -0.3rem;
            left: 0.3rem;
          }

          .hidden {
            display: none;
          }
        .flip-card {
          width: 100%;
          max-width: 390px;
          height: auto;
          min-height: 650px;
          perspective: 1000px;
          margin: 0 auto;
        }

        .flip-card-inner {
          position: relative;
          width: 100%;
          height: 100%;
          transition: transform 0.6s;
          transform-style: preserve-3d;
          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }

        .flip-card.flipped .flip-card-inner {
          transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
          position: absolute;
          width: 100%;
          height: 100%;
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
        }

        .flip-card-back {
            background: linear-gradient(135deg, #30baba 0%, #2a9d9d 100%);
            color: white;
            width: 100%;
            height: 100%;
            min-height: 650px;
            transform: rotateY(180deg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .flip-card-back::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .checkmark {
            width: 40px;
            height: 40px;
            border: 3px solid white;
            border-radius: 50%;
            position: relative;
        }

        .checkmark::after {
            content: '';
            position: absolute;
            left: 12px;
            top: 6px;
            width: 8px;
            height: 16px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .success-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
        }

        .success-message {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 35px;
            opacity: 0.95;
            max-width: 280px;
        }

        .small-grey-underline {
          cursor: pointer;
          margin-top: 20px;
          font-size: 16px; 
          color: #ffffff;
          transition: all 0.3s ease;
          display: inline-block;
          user-select: none;
          text-decoration: underline;
          font-weight: 500;
          backdrop-filter: blur(10px);
          border: none;
          background: none;
        }
        @media (max-width: 768px) {
        .flip-card {
          width: 95%;
          max-width: 350px;
          min-height: 600px;
        }
        
        .flip-card-inner {
          min-height: 600px;
        }
        
        .flip-card-front, .flip-card-back {
          min-height: 600px;
        }
        
        .flip-card-front {
          padding: 15px;
        }
        
        .flip-card-back {
          padding: 20px;
          min-height: 600px;
        }
        
        .success-title {
          font-size: 24px;
        }
        
        .success-message {
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .flip-card {
          width: 100%;
          max-width: 320px;
          min-height: 600px;
        }
        
        .flip-card-inner {
          min-height: 600px;
        }
        
        .flip-card-front, .flip-card-back {
          min-height: 600px;
        }
        
        .flip-card-front {
          padding: 10px;
        }
        
        .flip-card-back {
          padding: 15px;
          min-height: 550px;
        }
        
        .card-title {
          font-size: 1.3rem;
        }
        
        .success-icon {
          width: 60px;
          height: 60px;
        }
        
        .checkmark {
          width: 30px;
          height: 30px;
        }
        
        .checkmark::after {
          left: 9px;
          top: 4px;
          width: 6px;
          height: 12px;
        }
      }

</style>

<script>
  import flatpickr from 'flatpickr'
  let lastSelectedDate = '';
  flatpickr('.date-picker', {
    dateFormat: 'Y-m-d',
    minDate: 'today',

    onOpen: function (selectedDates, dateStr, instance) {
      const calendarContainer = instance.calendarContainer
      const monthElement = calendarContainer.querySelector(
        '.flatpickr-month'
      ) as HTMLElement
      const monthDropDown = calendarContainer.querySelector(
        '.flatpickr-monthDropdown-months'
      ) as HTMLElement
      const DropDownMonth = calendarContainer.querySelectorAll(
        '.flatpickr-monthDropdown-month'
      ) as NodeListOf<HTMLElement>
      const weekdays = calendarContainer.querySelectorAll(
        '.flatpickr-weekday'
      ) as NodeListOf<HTMLElement>
      const currMonth = calendarContainer.querySelector(
        '.flatpickr-current-month'
      ) as HTMLElement

      if (monthElement && monthDropDown && weekdays && DropDownMonth) {
        monthElement.style.backgroundColor = '#121519'
        monthDropDown.style.backgroundColor = '#121519'
        currMonth.style.display = 'flex'
        currMonth.style.justifyContent = 'space-between'
        weekdays.forEach((weekday) => {
          weekday.style.backgroundColor = '#121519'
        })
        DropDownMonth.forEach((month) => {
          month.style.backgroundColor = '#121519'
        })
      }
    },
    onClose: async function (selectedDates, dateStr, instance) {
      try {
        if (dateStr === lastSelectedDate) {
          return; 
        }
        lastSelectedDate = dateStr; 
        if (dateStr === '') {
          const selectElement = document.getElementById('time-slots-options') as HTMLSelectElement
          selectElement.innerHTML = '<option value="" selected style="background-color: #121519;">Choose date first</option>'
          return
        }
        const selectElement = document.getElementById(
          'time-slots-options'
        ) as HTMLSelectElement
        const slotsContainer = document.getElementById(
          'time-slots-container'
        ) as HTMLElement
        const BookBtn = document.querySelector('#book-now') as HTMLButtonElement

          selectElement.innerHTML = '<option value="" selected style="background-color: #121519;">Loading available slots...</option>'
          selectElement.disabled = true

        var timezone = Intl.DateTimeFormat().resolvedOptions().timeZone

       const appScriptID = import.meta.env.PUBLIC_GOOGLE_APP_SCRIPT_ID

        var url = `https://script.google.com/macros/s/${appScriptID}/exec`

        var res = await fetch(`${url}?date=${dateStr}&timezone=${timezone}`)

        var data = await res.json()

        const availableSlots = data.availableSlots
        selectElement.disabled = false
        selectElement.innerHTML = ''

        selectElement.innerHTML = ''

        if (availableSlots.length === 0) {
          const option = document.createElement('option') as HTMLOptionElement
          option.value = ''
          option.textContent = 'No Available Slots'
          option.selected = true
          option.style.backgroundColor = '#121519'
          selectElement.appendChild(option)
          slotsContainer.classList.remove('hidden')
          return
        } else {
          const option = document.createElement('option')
          option.value = ''
          option.textContent = 'Choose available time slots'
          option.selected = true
          option.style.backgroundColor = '#121519'
          selectElement.appendChild(option)
        }

        availableSlots.forEach((slot: any) => {
          let option = document.createElement('option')
          option.value = slot
          option.textContent = slot
          option.style.backgroundColor = '#121519'
          selectElement.appendChild(option)
        })
        slotsContainer.classList.remove('hidden')
        BookBtn.disabled = false
        validateForm()
      } catch (error) {
        console.log('error :>> ', error)
        const selectElement = document.getElementById('time-slots-options') as HTMLSelectElement
        selectElement.disabled = false
        selectElement.innerHTML = '<option value="" selected style="background-color: #121519;">Error loading slots. Please try again.</option>'
      }
    }
  })
  const form_id = import.meta.env.PUBLIC_FORM_ID
  const appScriptID = import.meta.env.PUBLIC_GOOGLE_APP_SCRIPT_ID
  
  const submitAnotherForm = document.querySelector('.small-grey-underline') as HTMLElement
  submitAnotherForm?.addEventListener('click', () => {
    const flipCard = document.querySelector('.flip-card') as HTMLElement
    flipCard.classList.remove('flipped')
  })
  const BookBtn = document.querySelector('#book-now') as HTMLButtonElement
  BookBtn?.addEventListener('click', async (e) => {
    e.preventDefault()
    // do validation checks
    const nameInput = document.querySelector('#name') as HTMLInputElement
    const emailInput = document.querySelector('#email') as HTMLInputElement
    const companyInput = document.querySelector('#company') as HTMLInputElement
    const dateTimeInput = document.querySelector(
      '#date-time-picker'
    ) as HTMLInputElement
    const dateSet = document.getElementById('date-set') as HTMLElement
    const timeSlots = document.getElementById(
      'time-slots-options'
    ) as HTMLSelectElement
    const timeSlotsContainer = document.getElementById(
      'time-slots-container'
    ) as HTMLElement

    const name = nameInput.value
    const email = emailInput.value
    const company = companyInput.value
    const startDateTime = dateTimeInput.value
    const timeSlot = timeSlots.value

    if (name && email && company && startDateTime && timeSlot) {
      const url = `https://docs.google.com/forms/d/e/${form_id}/formResponse`
      const scriptUrl = `https://script.google.com/macros/s/${appScriptID}/exec`
      try {
        const formData = new FormData()
        formData.append('entry.1291198894', name)
        formData.append('entry.1637227755', company)
        formData.append('entry.800910305', startDateTime)
        formData.append('entry.1284317816', timeSlot)
        formData.append('entry.59580764', email)
        formData.append('ScheduledBy', 'Digital Back Office team')
        function parseTime(timeStr: any , year: any , month: any , day: any) {
          var timeParts = timeStr.match(/(\d+):(\d+) (\w{2})/)
          var hours = parseInt(timeParts[1], 10)
          var minutes = parseInt(timeParts[2], 10)
          var period = timeParts[3]

          if (period === 'PM' && hours !== 12) {
            hours += 12
          } else if (period === 'AM' && hours === 12) {
            hours = 0
          }
          return new Date(year, month, day, hours, minutes)
        }
        var dateParts = startDateTime.split('-')
        var year = parseInt(dateParts[0], 10)
        var month = parseInt(dateParts[1], 10) - 1
        var day = parseInt(dateParts[2], 10)
        var time = timeSlot.split('-')
        var startTime = parseTime(time[0], year, month, day)
        var endTime = parseTime(time[1], year, month, day)
        formData.append('StartTime', startTime.toString())
        formData.append('EndTime', endTime.toString())
        await fetch(url, {
          method: 'POST',
          body: formData,
        }).catch((error) => {
        });
        fetch(scriptUrl, {
          method: 'POST',
          body: formData
        })
          .then((res) => {
            res.json()
          })
          .then((data) => {
            const flipCard = document.querySelector('.flip-card') as HTMLElement
            flipCard.classList.add('flipped')
            emailInput.value = ''
            companyInput.value = ''
            nameInput.value = ''
            dateTimeInput.value = ''
            BookBtn.disabled = true
            const selectElement = document.getElementById('time-slots-options') as HTMLSelectElement
            selectElement.innerHTML = '<option value="" selected style="background-color: #121519;">Choose date first</option>'
          })
          .catch((error) => {
            console.log('error while creating event :>> ', error)
          })
      } catch (error) {
        console.log(error)
      }
    }
  })
  function validateForm() {
  const nameInput = document.querySelector('#name') as HTMLInputElement
  const emailInput = document.querySelector('#email') as HTMLInputElement
  const companyInput = document.querySelector('#company') as HTMLInputElement
  const dateTimeInput = document.querySelector('#date-time-picker') as HTMLInputElement
  const timeSlots = document.getElementById('time-slots-options') as HTMLSelectElement
  const BookBtn = document.querySelector('#book-now') as HTMLButtonElement

  const name = nameInput.value.trim()
  const email = emailInput.value.trim()
  const company = companyInput.value.trim()
  const startDateTime = dateTimeInput.value.trim()
  const timeSlot = timeSlots.value.trim()
  if (name && email && company && startDateTime && timeSlot) {
    BookBtn.disabled = false
  } else {
    BookBtn.disabled = true
  }
}
document.addEventListener('DOMContentLoaded', function() {
  const nameInput = document.querySelector('#name') as HTMLInputElement
  const emailInput = document.querySelector('#email') as HTMLInputElement
  const companyInput = document.querySelector('#company') as HTMLInputElement
  const timeSlots = document.getElementById('time-slots-options') as HTMLSelectElement
  nameInput?.addEventListener('input', validateForm)
  emailInput?.addEventListener('input', validateForm)
  companyInput?.addEventListener('input', validateForm)
  timeSlots?.addEventListener('change', validateForm)
})
</script>
<div class="flip-card">
  <div class="flip-card-inner">
    <div class="flip-card-front">
<form class='card-body'>
  <h2 class='h3 card-title text-white text-center pb-2 pb-xxl-3'>
    30 mins FREE Consultation
  </h2>
  <div class='mb-2'>
    <label class='form-label fs-base' for='name'> Your Name</label>
    <input
      class='form-control form-control-lg fs-sm'
      type='text'
      placeholder='Enter your name'
      name='Name'
      required
      id='name'
    />
  </div>
  <div class='mb-2'>
    <label class='form-label fs-base' for='company'> Company Name</label>
    <input
      class='form-control form-control-lg fs-sm'
      type='text'
      placeholder="Enter your company's name"
      name='Company-name'
      required
      id='company'
    />
  </div>
  <div class='mb-2'>
    <label class='form-label fs-base' for='email'> Email address</label>
    <input
      class='form-control form-control-lg fs-sm'
      type='email'
      placeholder='Enter your email address'
      name='Email'
      required
      id='email'
    />
  </div>
  <div class='mb-2'>
    <label class='form-label' for='date-time-picker'>Date</label>
    <div class='position-relative'>
      <input
        class='form-control form-control-lg date-picker pe-5 fs-sm'
        type='text'
        placeholder='Choose available date'
        name='Date-time'
        required
        id='date-time-picker'
      />
      <i
        class='ai-calendar position-absolute top-50 end-0 translate-middle-y fs-lg text-white opacity-80 me-3'
      ></i>
    </div>
  </div>
  <div class='mb-2' id='time-slots-container'>
    <label class='form-label' for='time-slots'>Time</label>
    <div class='position-relative'>
      <select
        name='time-slots'
        id='time-slots-options'
        class='form-control form-control-lg pe-5 fs-sm'
      >
        <option value='' selected style='background-color: #121519;'>Choose date first</option>
      </select>
    </div>
  </div>
  <div
    class='d-flex flex-column flex-sm-row flex-lg-column flex-xxl-row align-items-center justify-content-center justify-content-lg-start pt-3 pt-xxl-4'
  >
    <button
      id='book-now'
      disabled
      class={url === '/'
        ? ' btn btn-lg btn-outline-primary text-white book-btn w-100 h-100 py'
        : 'btn btn-lg btn-outline-primary text-white book-btn w-100 h-100 py bookNow-btn'}
      type='submit'>Book now</button
    >
  </div>
</form>
</div>
    <div class="flip-card-back">
              <div class="success-icon">
            <div class="checkmark"></div>
        </div>
        <h2 class="success-title">Time Slot Booked!</h2>
        <p class="success-message">
            Your appointment has been successfully scheduled. You will receive a confirmation email shortly with all the details.
        </p>
<button class="small-grey-underline">
Submit another form
</button>
    </div>
  </div>
</div>